{% extends "lavaFlow/base.html" %}
{% block actions %} 
	<li><a id="permalinkURL" href='#'><span class="glyphicon glyphicon-link"></span></a></li>
	<li><a href="#"><span id="filterIcon" class="glyphicon glyphicon-filter"></span></a></li>
    <li><a href="#" data-toggle="modal" data-target="#filterModal"><span id="filterModallinkIcon" class="glyphicon glyphicon-question-sign"></span><span id="filterCount" class="badge"></span></a></li>
{% endblock %}
{% block title %}Utilization View{% endblock %}
{% block content %}
<div id="rangeSelector">
	<div id="slider"></div>
	<p id="rangeText">Loading report range....</p>
</div>
<script>
	var selectedMin={{ start_time }};
	var selectedMax={{ end_time }};
	var buildFilterUrl='{{ build_filter_url|safe }}';
	var filters={{ filters|safe }};
	var excludes={{ excludes|safe }};
	var count=0;



	$('#filterIcon').popover({
		"animation":true,
		"placement":"bottom",
		"html":true,
		"title":"Report Information",
		"content":function (){
			return buildPopoverText();
		}
	});
	function buildPopoverText(){
		var h;
		h="<dl><dt># Entries</dt><dd>"+count+"</dd>";
		for (var key in filters) {
	  		if (filters.hasOwnProperty(key)) {
				h += "<dt>Filter on " + key + "</dt><dl>";
				if (endsWith(key,"__in")){
					filters[key].forEach(function(entry){
						h+="<a href='#' onClick=\"removeFilter('"+key+"','"+entry+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+entry+" ";
					});
				}else{
					h+="<a href='#' onClick=\"removeFilter('"+key+"','"+filters[key]+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+filters[key]+" ";
				}
				h +="</dd>";
			}
		}
		for (var key in excludes) {
	  		if (excludes.hasOwnProperty(key)) {
				h += "<dt>Exclude " + key + "</dt><dl>";
				if (endsWith(key,"__in")){
					excludes[key].forEach(function(entry){
						h+="<a href='#' onClick=\"removeExclude('"+key+"','"+entry+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+entry+" ";
					});
				}else{
				h+="<a href='#' onClick=\"removeExclude('"+key+"','"+excludes[key]+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+excludes[key]+" ";
				}
				h +="</dd>";
			}
		}
		h+="</dl>";
		return h;
	}

	// Add the slider
	$( "#slider" ).slider({
		range: true,
		disabled: true,
		slide: function( event, ui ){
			var startDate=new Date(ui.values[0]);
			var endDate=new Date(ui.values[1]);
			$("#rangeText").text('Report start: ' + startDate + ', report end: ' + endDate );
		},
		change: function(event, ui){
			selectedMin=ui.values[0];
			selectedMax=ui.values[1];
			if (! $("#slider").slider("option", "disabled")){
				updateReport();
			}
		},
	});


function create_chart(chart_name){
    var chart_selector="#" + chart_name + " svg";
    if (chart_data[chart_name].chart_type=="area"){
        nv.addGraph(function() {
            chart_data[chart_name].chart = nv.models.stackedAreaChart();
            chart_data[chart_name].chart.clipEdge(true);
            chart_data[chart_name].chart.xAxis.tickFormat(function(d) { return d3.time.format('%x %X')(new Date(d)) });
            chart_data[chart_name].chart.xAxis.rotateLabels(-45);
            chart_data[chart_name].chart.margin({bottom: 120, left:100});
            chart_data[chart_name].chart.xAxis.axisLabel('Date');
            chart_data[chart_name].chart.showControls(false);
            d3.select(chart_selector)
            .datum([])
            .transition().duration(500)
            .call(chart_data[chart_name].chart);
            nv.utils.windowResize(chart_data[chart_name].chart.update);
            return chart_data[chart_name].chart;
        });
    }
    if (chart_data[chart_name].chart_type=="bar"){
        nv.addGraph(function() {
            chart_data[chart_name].chart = nv.models.multiBarChart();

            if (chart_data[chart_name].hasOwnProperty("chart_attributes")){
                $.each(chart_data[chart_name].chart_attributes, function( index, value ) {
                    var c=chart_data[chart_name].chart;
                    var fields = value.key.split(".");
                    while(fields.length > 1){
                        c=c[fields.shift()];
                    }
                    c[fields.shift()](value.value);
                });
            }
            d3.select(chart_selector)
                .datum([])
                .transition().duration(500)
                .call(chart_data[chart_name].chart);
            nv.utils.windowResize(chart_data[chart_name].chart.update);
            return chart_data[chart_name].chart;
        });
    }
}
function create_charts(){
    for (var chart_name in chart_data){
        create_chart(chart_name);

    }
}

	// Updates the RangeSlider widget, if there is data - loads data into charts.
	function updateRangeSlider(){
	$( "#slider" ).slider( "option", "disabled", true );
		var filterData={
			view:'lf_get_report_range',
			filters:filters,
			excludes:excludes,
			groups:[],
			start_time_js:selectedMin,
			end_time_js:selectedMax
		};
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$.getJSON(data.url, function(data) {
				if (data.count>0){
					count=data.count;
					// If using default values, populate them
					if ( selectedMin < data.start_time ){
						selectedMin=data.suggested_start_time;
					}
					if ( selectedMax > data.end_time ){
						selectedMax=data.suggested_end_time;
					}
					if (selectedMax-selectedMin < 1){
						selectedMax=data.suggested_end_time;
						selectedMin=data.suggested_start_time;
					}

					// Set the counter to the amount of data
					$("#counterText").text(data.count);

					// Set the report range
					var startDate=new Date(selectedMin);
					var endDate=new Date(selectedMax);
					$("#rangeText").text('Report start: ' + startDate + ', report end: ' + endDate );

					// Set the range
					$( "#slider" ).slider( "option", "max", data.end_time );
					$( "#slider" ).slider( "option", "min", data.start_time );

					// Set the selection
					$( "#slider" ).slider( "option", "values", [ selectedMin, selectedMax ]);

					// Enable the slider
					$( "#slider" ).slider( "option", "disabled", false );

					loadWidgets();
				}
				else{
					// Disable the slider
					$( "#slider" ).slider( "option", "disabled", true );
					$("#rangeText").text('No data was found for this filter.' );
				}
			});
		});
	}



	function initializeReport(){
	    create_charts();
		updateRangeSlider();
	}
	function updateReport(){
		// Disabale the slider
		$( "#slider" ).slider( "option", "disabled", true );

		clearWidgets();
		updateRangeSlider();
	}


	function endsWith(str, suffix) {
    	return str.indexOf(suffix, str.length - suffix.length) !== -1;
	}

	function addFilter(filterName, value){
		if ( endsWith(filterName, "__in" )){
			if ( !filters.hasOwnProperty(filterName) ){
				filters[filterName]=[];
			}
			filters[filterName].push(value)
		}else{
			filters[filterName]=value
		}
		updateReport();
	}
	function removeFilter(filterName,value){
		if (filters.hasOwnProperty(filterName)){
			if (endsWith(filterName, "__in")){
				var loc=filters[filterName].indexOf(value);
				if (loc >-1){
					filters[filterName].splice(loc);
					if ( filters[filterName].length <1 ){
						delete filters[filterName];
					}
					updateReport();
				}
			}
			else{
				delete filters[filterName];
				updateReport();
			}
		}
	}
	function removeExclude(excludeName,value){
		if (excludes.hasOwnProperty(excludeName)){
			if (endsWith(excludeName, "__in")){
				var loc=excludes[excludeName].indexOf(value);
				if (loc >-1){
					excludes[excludeName].splice(loc);
					if ( excludes[excludeName].length <1 ){
						delete excludes[excludeName];
					}
					updateReport();
				}
			}
			else{
				delete excludes[excludeName];
				updateReport();
			}
		}
	}

	function addExclude(excludeName, value){
		if ( endsWith(excludeName, "__in" )){
			if ( !excludes.hasOwnProperty(excludeName) ){
				excludes[excludeName]=[];
			}
			excludes[excludeName].push(value)
		}else{
			excludes[excludeName]=value
		}
		updateReport();
	}

    var chart_data={
        chart_cpu:{
            chart_attributes:[
                {
                    key:"xAxis.tickFormat",
                    value:function(d) { return d3.time.format('%x %X')(new Date(d)) }
                },
                {
                    key:"xAxis.rotateLabels",
                    value:-45,
                },
                {
                    key:"xAxis.axisLabel",
                    value:"Date",
                }
            ],
            active: "overall",
            chart: null,
            chart_type: "bar",
            chart_view: "lf_cpu_consumption_chart",
            data:{
                overall:{
                    groups:[],
                    chart_data:[],
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:[],
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:[],
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:[],
                    table_data:[]
                },
                user:{
                    groups:["user__name"],
                    chart_data:[],
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:[],
                    table_data:[]
                },
            }
        },
        chart_resources:{
            active: "overall",
            chart: null,
            chart_type: "bar",
            chart_view: "lf_resource_chart",
            data:{
                overall:{
                    groups:[],
                    chart_data:[],
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:[],
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:[],
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:[],
                    table_data:[]
                },
                user:{
                    groups:["user__name"],
                    chart_data:[],
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:[],
                    table_data:[]
                },
            }
        },
        chart_submission:{
            active: "overall",
            active_field: "submit_hour_of_day",
            chart: null,
            chart_type: "bar",
            chart_view: "lf_submission_chart",
            data:{
                overall:{
                    groups:[],
                    chart_data:{
                        "submit_hour_of_day":[],
                        "submit_day_of_week":[],
                        "submit_day_of_month":[],
                        "submit_week_of_year":[],
                        "submit_month":[],
                    },
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:{
                        "submit_hour_of_day":[],
                        "submit_day_of_week":[],
                        "submit_day_of_month":[],
                        "submit_week_of_year":[],
                        "submit_month":[],
                    },
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:{
                        "submit_hour_of_day":[],
                        "submit_day_of_week":[],
                        "submit_day_of_month":[],
                        "submit_week_of_year":[],
                        "submit_month":[],
                    },
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:{
                        "submit_hour_of_day":[],
                        "submit_day_of_week":[],
                        "submit_day_of_month":[],
                        "submit_week_of_year":[],
                        "submit_month":[],
                    },
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:{
                        "submit_hour_of_day":[],
                        "submit_day_of_week":[],
                        "submit_day_of_month":[],
                        "submit_week_of_year":[],
                        "submit_month":[],
                    },
                    table_data:[]
                },
            },
        },
        chart_consumption:{
            active: "overall",
            chart: null,
            chart_type: "bar",
            chart_view: "lf_consumption_chart",
            data:{
                overall:{
                    groups:[],
                    chart_data:[],
                    table_data:[]
                },
                exit:{
                    groups:["status__name"],
                    chart_data:[],
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:[],
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:[],
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:[],
                    table_data:[]
                },
                user:{
                    groups:["user__name"],
                    chart_data:[],
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:[],
                    table_data:[]
                },
            },
        },
        chart_utilization:{
            active: "overall",
            chart: null,
            chart_type: "area",
            chart_view: "lf_util_chart_view",
            table_view:"lf_utilization_table",
            data:{
                overall:{
                    groups:[],
                    chart_data:[],
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:[],
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:[],
                    table_data:[]
                },
                user:{
                    groups:["user__name"],
                    chart_data:[],
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:[],
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:[],
                    table_data:[]
                },
            },
        },
    };


    var empty_chart=[
        {
            key:"Loading...",
            values:[
            {x:0, y:0}, {x:1, y:0}
            ]
        }
    ];
    function set_active_chart(selector, state){

        chart_data[selector].active = state;
        // Change the classes in the tabs...
        var wanted_selector=selector+"_"+state;
        for (var value in chart_data[selector].data){
            var v = selector+"_"+value;
            document.getElementById(v).className ="";
            if (v.valueOf() === wanted_selector.valueOf()){
                document.getElementById(v).className ="active";
            }
        }

        // Set the attributes for the active graph
        var chart_selector="#" + selector + " svg";
        var data=[];
        if ( chart_data[selector].hasOwnProperty("active_field")){
            var field = chart_data[selector].active_field;
            chart_data[selector].active_field = field;
            data=chart_data[selector].data[state].chart_data[field];
        }else{
            data=chart_data[selector].data[state].chart_data;
        }
        d3.select(chart_selector)
            .datum(empty_chart)
            .transition().duration(500)
            .call(chart_data[selector].chart);
        d3.select(chart_selector)
            .datum(data)
            .transition().duration(500)
            .call(chart_data[selector].chart);

        $("#" + selector+"_table").html(chart_data[selector].data[state].table_data);
    }

    function set_active_field(selector, field){
        var current_state = chart_data[selector].active;
        chart_data[selector].active_field = field;
        // Change the classes in the tabs...
        var wanted_selector=selector+"_"+field;
        for (var value in chart_data[selector].data[current_state].chart_data){
            var v = selector+"_"+value;
            document.getElementById(v).className ="";
            if (v.valueOf() === wanted_selector.valueOf()){
                document.getElementById(v).className ="active";
            }
        }
        set_active_chart(selector, current_state);
    }



	function clearWidgets(){
	    for (var c_name in chart_data){
	        var selector="#"+c_name+" svg";
	        d3.select(selector)
                .datum(empty_chart)
                .transition().duration(500)
                .call(chart_data[c_name].chart);
            d3.select(selector)
                .datum([])
                .transition().duration(500)
                .call(chart_data[c_name].chart);
            if (chart_data[c_name].hasOwnProperty( "table_view" )){
                $("#"+c_name+"_table").html('Updating.....');
            }
	    }

	}

    function load_chart(chart_name, view_name, field){
        var chart_selector="#" + chart_name + " svg";
        var table_selector="#" + chart_name + "_table";
        var filterData={
			filters:filters,
			excludes:excludes,
			start_time_js:selectedMin,
			end_time_js:selectedMax
		};


		filterData.groups=chart_data[chart_name].data[view_name].groups;
		filterData.view=chart_data[chart_name].chart_view;

		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    var params="";
		    if (field && field.length > 0){
		        params="?" + $.param({field:field});
		    }
            $.getJSON(data.url + params, function(data) {
                var chart=chart_data[chart_name];
		        var view=chart.data[view_name];

                if ( chart.hasOwnProperty("active_field")){
                    view.chart_data[field]=data['data'];
                    if (chart.active==view_name && chart.active_field == field){
                        d3.select(chart_selector)
                        .datum(view.chart_data[field])
                        .transition().duration(500)
                        .call(chart.chart);
                    }
                }else{
                    view.chart_data=data['data'];
                    if (chart.active==view_name){
                        d3.select(chart_selector)
                        .datum(view.chart_data)
                        .transition().duration(500)
                        .call(chart.chart);
                    }
                }
            });
        });
        if (chart_data[chart_name].hasOwnProperty( "table_view" )){
            filterData.view=chart_data[chart_name].table_view;
            $.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
                $.get(data.url, function(data) {
                    var chart=chart_data[chart_name];
                    var view=chart.data[view_name];
                    view.table_data=data;
                    // Check if selected, then display....
                    if (chart.active==view_name){
                        $(table_selector).html(view.table_data);
                    }
                });
            });
        }


    }

	function loadWidgets(){
		// Loads data into widgets
		var filterData={
			view:'lf_utilization_view',
			filters:filters,
			excludes:excludes,
			groups:[],
			start_time_js:selectedMin,
			end_time_js:selectedMax
		};

		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$("#permalinkURL").attr("href", data.url);
		});

		filterData.view='lf_util_total_attempts';
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$("#counterText").text(data.count);
		});

        for (var chart_name in chart_data){
            for (var view_name in chart_data[chart_name].data){
                if (chart_data[chart_name].hasOwnProperty("active_field")){
                    for (var field_name in chart_data[chart_name].data[view_name].chart_data){
                        load_chart(chart_name, view_name, field_name);
                    }
                }else{
                    load_chart(chart_name, view_name);
                }
            }
        }
    }



	initializeReport();
</script>

<h1>Utilization</h1>
<p>The Utilization Chart shows the utilization of the cluster grouped by the selected field.  Utilization shows the number
of processors that were in use at any given time, stacked on top of this are the corresponding number of processors that
were pending at that time.  Pending tasks are those that have been submitted to the cluster but are not executing.</p>

<ul id="chart_utilization_nav" class="nav nav-tabs">
    <li id="chart_utilization_overall" class="active"><a href="#" onClick='set_active_chart("chart_utilization", "overall"); return false;'>Overall</a></li>
    <li id="chart_utilization_cluster"><a href="#" onClick='set_active_chart("chart_utilization", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_utilization_queue"><a href="#" onClick='set_active_chart("chart_utilization", "queue"); return false;'>By Queue</a></li>
    <li id="chart_utilization_project"><a href="#" onClick='set_active_chart("chart_utilization", "project"); return false;'>By Project</a></li>
    <li id="chart_utilization_user"><a href="#" onClick='set_active_chart("chart_utilization", "user"); return false;'>By User</a></li>
    <li id="chart_utilization_size"><a href="#" onClick='set_active_chart("chart_utilization", "size"); return false;'>By Size</a></li>
</ul>
<div id="chart_utilization">
    <svg height="400px"></svg>
</div>
<div id="chart_utilization_table"></div>

<h1>Consumption</h1>
<p>The resource consumption chart shows the total amount of time (in seconds) and the number of tasks that were active
    during this time.  Use this chart to see what the net consumption of the cluster is for a specific group of metrics.
    For example to see which job sizes consume the most CPU time on the cluster.</p>
<ul id="chart_consumption_nav" class="nav nav-tabs">
    <li id="chart_consumption_overall" class="active"><a href="#" onClick='set_active_chart("chart_consumption", "overall"); return false;'>Overall</a></li>
    <li id="chart_consumption_size"><a href="#" onClick='set_active_chart("chart_consumption", "size"); return false;'>By Job Size</a></li>
    <li id="chart_consumption_exit"><a href="#" onClick='set_active_chart("chart_consumption", "exit"); return false;'>By Exit Status</a></li>
    <li id="chart_consumption_cluster"><a href="#" onClick='set_active_chart("chart_consumption", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_consumption_project"><a href="#" onClick='set_active_chart("chart_consumption", "project"); return false;'>By Project</a></li>
    <li id="chart_consumption_queue"><a href="#" onClick='set_active_chart("chart_consumption", "queue"); return false;'>By Queue</a></li>
    <li id="chart_consumption_user"><a href="#" onClick='set_active_chart("chart_consumption", "user"); return false;'>By User</a></li>
</ul>

<div id='chart_consumption'><svg style='height:500px'></svg></div>
<div id="chart_consumption_table"></div>

<h1>Resource Usage</h1>
<p>Most schedulers gather resource usage information using the getrusage() system call. Not all schedulers support this
    operation, data will not be available for those jobs.  Use this chart to understand the characteristics of the jobs,
    how much RAM they use, if they are swapping, and if there are contention issues on the cluster for resources.
</p>
<ul id="chart_resources_nav" class="nav nav-tabs">
    <li id="chart_resources_overall" class="active"><a href="#" onClick='set_active_chart("chart_resources", "overall"); return false;'>Overall</a></li>
    <li id="chart_resources_size"><a href="#" onClick='set_active_chart("chart_resources", "size"); return false;'>By Job Size</a></li>
    <li id="chart_resources_cluster"><a href="#" onClick='set_active_chart("chart_resources", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_resources_project"><a href="#" onClick='set_active_chart("chart_resources", "project"); return false;'>By Project</a></li>
    <li id="chart_resources_queue"><a href="#" onClick='set_active_chart("chart_resources", "queue"); return false;'>By Queue</a></li>
    <li id="chart_resources_user"><a href="#" onClick='set_active_chart("chart_resources", "user"); return false;'>By User</a></li>
</ul>

<div id='chart_resources'><svg style='height:500px'></svg></div>
<div id="chart_resources_table"></div>
<h1>Job Submission</h1>
<p>The job submission chart shows how many jobs were submitted to the scheduling system at a given time period.  Use
this chart to see when the cluster is being used the most, and by which group.  This chart helps you understand usage
patterns of the cluster, along with the utilization and CPU consumption chart, it can help understand when capacity
is most needed.</p>

<ul id="chart_submission_nav" class="nav nav-tabs">
    <li id="chart_submission_overall" class="active"><a href="#" onClick='set_active_chart("chart_submission", "overall"); return false;'>Overall</a></li>
    <li id="chart_submission_size"><a href="#" onClick='set_active_chart("chart_submission", "size"); return false;'>By Job Size</a></li>
    <li id="chart_submission_cluster"><a href="#" onClick='set_active_chart("chart_submission", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_submission_project"><a href="#" onClick='set_active_chart("chart_submission", "project"); return false;'>By Project</a></li>
    <li id="chart_submission_queue"><a href="#" onClick='set_active_chart("chart_submission", "queue"); return false;'>By Queue</a></li>
</ul>
<ul class="nav nav-tabs">
  <li id="chart_submission_submit_hour_of_day" class="active"><a onClick='set_active_field("chart_submission", "submit_hour_of_day"); return false;' href="#">By Hour</a></li>
  <li id="chart_submission_submit_day_of_week"><a onClick='set_active_field("chart_submission", "submit_day_of_week"); return false;' href="#">By Day of Week</a></li>
  <li id="chart_submission_submit_day_of_month"><a onClick='set_active_field("chart_submission", "submit_day_of_month"); return false;' href="#">By Day of Month</a></li>
  <li id="chart_submission_submit_week_of_year"><a onClick='set_active_field("chart_submission", "submit_week_of_year"); return false;' href="#">By Week of Year</a></li>
  <li id="chart_submission_submit_month"><a onClick='set_active_field("chart_submission", "submit_month"); return false;' href="#">By Month of Year</a></li>
</ul>

<div id='chart_submission'><svg style='height:500px'></svg></div>
<div id="chart_submission_table"></div>

<h1>CPU Consumption Rate</h1>
    <p>
        This chart shows the CPU Consumption rate grouped accordingly, this is the rate at which CPU hours are being
        consumed.  The table below shows the total amount of CPU hours consumed.  This is similar to an energy meter and
        an energy bill respectively.  The graph shows how much was being used on average over for that period, and the
        table shows how much was being used.  The rates CPU Hours per Hour used for the rate, and CPU Hours for the total.  A
        single cpu hour is the base unit of measurement and donates a CPU core that was occupied by a task for a total
        of one hour.  Example:  A job running on ten CPUs is consuming CPU time at a rate of ten cpu hours per hour, if
        the job runs for half an hour, it will consume 5 CPU Hours of resource.
    </p>
    <p>How does this char differ from utilization? First, the utilization is a snapshot of the cluster state at a given
    moment in time, measuring the exact number of cores in use, and the exact number of cores pending.  This chart shows
    an average value.  The utilization chart shows demand on the cluster, this chart shows average consumption.  A
    subtle but important distinction.</p>
<ul id="chart_cpu_nav" class="nav nav-tabs">
    <li id="chart_cpu_overall" class="active"><a href="#" onClick='set_active_chart("chart_cpu", "overall"); return false;'>Overall</a></li>
    <li id="chart_cpu_size"><a href="#" onClick='set_active_chart("chart_cpu", "size"); return false;'>By Job Size</a></li>
    <li id="chart_cpu_cluster"><a href="#" onClick='set_active_chart("chart_cpu", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_cpu_project"><a href="#" onClick='set_active_chart("chart_cpu", "project"); return false;'>By Project</a></li>
    <li id="chart_cpu_queue"><a href="#" onClick='set_active_chart("chart_cpu", "queue"); return false;'>By Queue</a></li>
    <li id="chart_cpu_user"><a href="#" onClick='set_active_chart("chart_cpu", "user"); return false;'>By User</a></li>
</ul>
<div id='chart_cpu'><svg style='height:500px'></svg></div>
<div id="chart_cpu_table"></div>
<br /><br /><br /><br /><br />



<!-- Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="filterModalLabel">Modify Filters</h4>
      </div>
      <div class="modal-body">
          <div class="container-fluid">
              <div class="row">
                  <div class="col-xs-6">
                        <ul>
                            {% for field in filter_data %}
                            <li>
                                <a href="#" onClick="update_value_list('{{ field.filter }}'); return false;">
                                  <span class="{{ field.filter }}_label"></span>
                                </a>
                                <a href="#" class="popover_help" data-toggle="popover" title="{{ field.display_name }}" data-content="{{ field.help_text }}"><span class="glyphicon question-sign"></span></a>
                            </li>
                            {% endfor %}
                         </ul>
                  <div class="col-xs-6">
                      <h2>Include</h2>
                      <div id="includeValueList">
                          <input type="text" class="form-control" id="include_search" placeholder="Search">
                          <select id="selected_filters" class="form-control" name="selected_filters" multiple="multiple">
                          </select>
                      </div>
                      <h2>Exclude</h2>
                      <div id="valueList">
                          <input type="text" class="form-control" id="exclude_search" placeholder="Search">
                          <select id="selected_excludes" class="form-control" name="selected_excludes" multiple="multiple">
                          </select>
                      </div>
                      <div class="panel panel-default">
                          <div class="panel-heading">
                            <h3 class="panel-title">Bounds</h3>
                          </div>
                          <div class="panel-body">
                            <div id="ComplexFilterControl">
                                <form class="form-inline" role="form">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <label class="sr-only" for="filter_type">Filter or Exclude</label>
                                            <select id="filter_type" class="form-control" name="filter_type">
                                                <option>Include</option>
                                                <option>Exclude</option>
                                            </select>
                                        </div>
                                    </div>
                                    <span id="field_name_label"></span>
                                    <div class="form-group">
                                        <div class="input-group">
                                            <label class="sr-only" for="filter_action">Email address</label>
                                            <select id="filter_action" class="form-control" name="filter_type">
                                                <option value="lt">Less Than</option>
                                                <option value="lte">Less Than or Equal</option>
                                                <option value="gt">Greater Than</option>
                                                <option value="gte">Greater Than or Equal</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="input-group">
                                            <label class="sr-only" for="filter_value">Value</label>
                                            <input type="text" id="filter_value" class="form-control" name="filter_type">
                                        </div>
                                    </div>
                                </form>
                                <a href="#" ><span class="glyphicon glyphicon-search"></span></a>
                            </div>
                          </div>
                          <div id="ActiveComplexFilters">

                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Update</button>
      </div>
    </div>
  </div>
</div>
<script>
    var filter_data=[];
        {% for field in filter_data %}
            filter_data['{{field.filter}}'] = {
                filter_string:'{{ field.filter }}',
                field_display:'{{ field.display_name }}',
                values:[],
                filter:{
                    in:[],
                    lt:null,
                    gt:null,
                    lte:null,
                    gte:null,
                },
                exclude:{
                    in:[],
                    lt:null,
                    gt:null,
                    lte:null,
                    gte:null,
                }
            };
        {% endfor %}
    {% endfor %}
</script>


<script>
    var active_filter="";
    function update_value_list(filter){
        active_filter=filter;
        if (filter_data[filter].values.length < 1){
            $.getJSON('{% url "lf_value_list" %}?' + $.param({field:filter}), function(data){
                filter_data[filter].values=data.data.values;
                if (active_filter == filter){
                  update_filter_widgets();
                }
            });
        }else{
            update_filter_widgets();
        }
    }
    function update_filter_widgets(){
        var filter_html="";
        var exclude_html="";
        $("#field_name_label").text(filter_data[active_filter].field_display);

        $.each(filter_data[active_filter].values, function (index, value){

            var selected=""
            if (filter_data[active_filter].filter.in.indexOf(value.value) == -1 ){
                // not in active filters
                selected = "";
            }else{
                selected = "selected"
            }
            filter_html += "<option value='"+value.value+"' "+ selected + ">"+value.display_value+"</option>";
            if (filter_data[active_filter].exclude.in.indexOf(value.value) == -1 ){
                // not in active filters
                selected = "";
            }else{
                selected = "selected"
            }
            exclude_html += "<option value='"+value.value+"' "+ selected + ">"+value.display_value+"</option>";
        });
        $('#selected_filters').html(filter_html);
        $('#selected_excludes').html(filter_html);
    }

    // Update the filters for active_filter
    $('#selected_filters').change(function() {
        filter_data[active_filter].filter.in = $("#selected_filters :selected").map(function(){ return this.value }).get();
        update_model_count();
    });

    // Update the excludes for active_filter
    $('#selected_excludes').change(function() {
        filter_data[active_filter].exclude.in = $("#selected_excludes :selected").map(function(){ return this.value }).get();
        update_model_count();
    });

    // Initialize Modal Help Popovers.
    $('.popover_help').popover();


    function update_model_count(){
        var count;
        var total=0;
        for(var propertyName in filter_data) {
            count = 0;
            count += filter_data[propertyName].filter.in.length;
            count += filter_data[propertyName].filter.lt ? 1 : 0;
            count += filter_data[propertyName].filter.lte ? 1 : 0;
            count += filter_data[propertyName].filter.gt ? 1 : 0;
            count += filter_data[propertyName].filter.gte ? 1 : 0;
            count += filter_data[propertyName].exclude.in.length;
            count += filter_data[propertyName].exclude.lt ? 1 : 0;
            count += filter_data[propertyName].exclude.lte ? 1 : 0;
            count += filter_data[propertyName].exclude.gt ? 1 : 0;
            count += filter_data[propertyName].exclude.gte ? 1 : 0;
            if (count > 0){
                $("."+filter_data[propertyName].filter_string + "_label").each(function(i, obj){
                    $(obj).html("<b>"+ $(obj).text() +"</b>");
                });
            }else{
                $("."+filter_data[propertyName].filter_string + "_label").each(function(i, obj){
                    $(obj).text($(obj).text());
                });
            }
            total+=count
        }
        if (total > 0){
            $("#filterCount").text(total);
        }else{
            $("#filterCount").text("");
        }
    }
</script>
{% endblock %}
