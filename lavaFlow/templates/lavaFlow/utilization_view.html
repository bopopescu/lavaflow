{% extends "lavaFlow/base.html" %}
{% block actions %} 
	<li>
		<a id="permalinkURL" href='#'><span class="glyphicon glyphicon-link"></span></a>
	</li>
	<li>
	<a href="#"><span id="filterIcon" class="glyphicon glyphicon-filter"></a></span>
	</li>

{% endblock %}
{% block title %}Utilization View{% endblock %}
{% block content %}
<div id="rangeSelector">
	<div id="slider"></div>
	<p id="rangeText">Loading report range....</p>
</div>
<script>
	var selectedMin={{ start_time }};
	var selectedMax={{ end_time }};
	var buildFilterUrl='{{ build_filter_url|safe }}';
	var filters={{ filters|safe }};
	var excludes={{ excludes|safe }};
	var count=0;

	$('#filterIcon').popover({
		"animation":true,
		"placement":"bottom",
		"html":true,
		"title":"Report Information",
		"content":function (){
			return buildPopoverText();
		}
	});
	function buildPopoverText(){
		var h;
		h="<dl><dt># Entries</dt><dd>"+count+"</dd>";
		for (var key in filters) {
	  		if (filters.hasOwnProperty(key)) {
				h += "<dt>Filter on " + key + "</dt><dl>";
				if (endsWith(key,"__in")){
					filters[key].forEach(function(entry){
						h+="<a href='#' onClick=\"removeFilter('"+key+"','"+entry+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+entry+" ";
					});
				}else{
					h+="<a href='#' onClick=\"removeFilter('"+key+"','"+filters[key]+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+filters[key]+" ";
				}
				h +="</dd>";
			}
		}
		for (var key in excludes) {
	  		if (excludes.hasOwnProperty(key)) {
				h += "<dt>Exclude " + key + "</dt><dl>";
				if (endsWith(key,"__in")){
					excludes[key].forEach(function(entry){
						h+="<a href='#' onClick=\"removeExclude('"+key+"','"+entry+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+entry+" ";
					});
				}else{
				h+="<a href='#' onClick=\"removeExclude('"+key+"','"+excludes[key]+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+excludes[key]+" ";
				}
				h +="</dd>";
			}
		}
		h+="</dl>";
		return h;
	}	

	// Add the slider
	$( "#slider" ).slider({
		range: true,
		disabled: true,
		slide: function( event, ui ){
			var startDate=new Date(ui.values[0]);
			var endDate=new Date(ui.values[1]);
			$("#rangeText").text('Report start: ' + startDate + ', report end: ' + endDate );
		},
		change: function(event, ui){
			selectedMin=ui.values[0];
			selectedMax=ui.values[1];
			if (! $("#slider").slider("option", "disabled")){
				updateReport();
			}
		},
	});

function create_charts(){
    for (var chart_name in chart_data){

        var chart_selector="#" + chart_name + " svg";

        if (chart_data[chart_name].chart_type=="area"){
            nv.addGraph(function() {
                chart_data[chart_name].chart = nv.models.stackedAreaChart();
                chart_data[chart_name].chart.clipEdge(true);
                chart_data[chart_name].chart.xAxis.tickFormat(function(d) { return d3.time.format('%x %X')(new Date(d)) });
                chart_data[chart_name].chart.xAxis.rotateLabels(-45);
                chart_data[chart_name].chart.margin({bottom: 120, left:100});
                chart_data[chart_name].chart.xAxis.axisLabel('Date');
                chart_data[chart_name].chart.showControls(false);
                d3.select(chart_selector)
                .datum([])
                .transition().duration(500)
                .call(chart_data[chart_name].chart);
                nv.utils.windowResize(chart_data[chart_name].chart.update);
                return chart_data[chart_name].chart;
	        });
        }

        if (chart_data[chart_name].chart_type=="bar"){


            nv.addGraph(function() {
                chart_data[chart_name].chart = nv.models.multiBarChart();
                d3.select(chart_selector)
                    .datum([])
                    .transition().duration(500)
                    .call(chart_data[chart_name].chart);
                nv.utils.windowResize(chart_data[chart_name].chart.update);
                return chart_data[chart_name].chart;
        	});
        }
    }
}

	// Updates the RangeSlider widget, if there is data - loads data into charts.
	function updateRangeSlider(){
	$( "#slider" ).slider( "option", "disabled", true );
		var filterData={
			view:'lf_get_report_range',
			filters:filters,
			excludes:excludes,
			groups:[],
			start_time_js:selectedMin,
			end_time_js:selectedMax
		};
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$.getJSON(data.url, function(data) {
				if (data.count>0){
					count=data.count;
					// If using default values, populate them 
					if ( selectedMin < data.start_time ){
						selectedMin=data.suggested_start_time;
					}
					if ( selectedMax > data.end_time ){
						selectedMax=data.suggested_end_time;
					}
					if (selectedMax-selectedMin < 1){
						selectedMax=data.suggested_end_time;
						selectedMin=data.suggested_start_time;
					}

					// Set the counter to the amount of data
					$("#counterText").text(data.count);

					// Set the report range
					var startDate=new Date(selectedMin);
					var endDate=new Date(selectedMax);
					$("#rangeText").text('Report start: ' + startDate + ', report end: ' + endDate );

					// Set the range
					$( "#slider" ).slider( "option", "max", data.end_time );
					$( "#slider" ).slider( "option", "min", data.start_time );

					// Set the selection
					$( "#slider" ).slider( "option", "values", [ selectedMin, selectedMax ]);
					
					// Enable the slider
					$( "#slider" ).slider( "option", "disabled", false );

					loadWidgets();
				}
				else{
					// Disable the slider
					$( "#slider" ).slider( "option", "disabled", true );
					$("#rangeText").text('No data was found for this filter.' );
				}
			});
		});
	}



	function initializeReport(){
	    create_charts();
		updateRangeSlider();
	}
	function updateReport(){
		// Disabale the slider
		$( "#slider" ).slider( "option", "disabled", true );

		clearWidgets();
		updateRangeSlider();
	}


	function endsWith(str, suffix) {
    	return str.indexOf(suffix, str.length - suffix.length) !== -1;
	}

	function addFilter(filterName, value){
		if ( endsWith(filterName, "__in" )){
			if ( !filters.hasOwnProperty(filterName) ){
				filters[filterName]=[];
			}
			filters[filterName].push(value)
		}else{
			filters[filterName]=value
		}
		updateReport();
	}
	function removeFilter(filterName,value){
		if (filters.hasOwnProperty(filterName)){
			if (endsWith(filterName, "__in")){
				var loc=filters[filterName].indexOf(value);
				if (loc >-1){
					filters[filterName].splice(loc);
					if ( filters[filterName].length <1 ){
						delete filters[filterName];
					}
					updateReport();
				}
			}
			else{
				delete filters[filterName];
				updateReport();
			}
		}
	}
	function removeExclude(excludeName,value){
		if (excludes.hasOwnProperty(excludeName)){
			if (endsWith(excludeName, "__in")){
				var loc=excludes[excludeName].indexOf(value);
				if (loc >-1){
					excludes[excludeName].splice(loc);
					if ( excludes[excludeName].length <1 ){
						delete excludes[excludeName];
					}
					updateReport();
				}
			}
			else{
				delete excludes[excludeName];
				updateReport();
			}
		}
	}

	function addExclude(excludeName, value){
		if ( endsWith(excludeName, "__in" )){
			if ( !excludes.hasOwnProperty(excludeName) ){
				excludes[excludeName]=[];
			}
			excludes[excludeName].push(value)
		}else{
			excludes[excludeName]=value
		}
		updateReport();
	}

    var chart_data={
        chart_resources:{
            active: "overall",
            chart: null,
            chart_type: "bar",
            chart_view: "lf_resource_chart",
            data:{
                overall:{
                    groups:[],
                    chart_data:[],
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:[],
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:[],
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:[],
                    table_data:[]
                },
                user:{
                    groups:["user__name"],
                    chart_data:[],
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:[],
                    table_data:[]
                },
            }
        },
        chart_submission:{
            active: "overall",
            chart: null,
            chart_type: "bar",
            chart_view: "lf_submission_chart",
            data:{
                overall:{
                    groups:[],
                    chart_data:[],
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:[],
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:[],
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:[],
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:[],
                    table_data:[]
                },
            },
        },
        chart_consumption:{
            active: "overall",
            chart: null,
            chart_type: "bar",
            chart_view: "lf_consumption_chart",
            data:{
                overall:{
                    groups:[],
                    chart_data:[],
                    table_data:[]
                },
                exit:{
                    groups:["status__name"],
                    chart_data:[],
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:[],
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:[],
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:[],
                    table_data:[]
                },
                user:{
                    groups:["user__name"],
                    chart_data:[],
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:[],
                    table_data:[]
                },
            },
        },
        chart_utilization:{
            active: "overall",
            chart: null,
            chart_type: "area",
            chart_view: "lf_util_chart_view",
            table_view:"lf_utilization_table",
            data:{
                overall:{
                    groups:[],
                    chart_data:[],
                    table_data:[]
                },
                cluster:{
                    groups:["cluster__name"],
                    chart_data:[],
                    table_data:[]
                },
                queue:{
                    groups:["queue__name"],
                    chart_data:[],
                    table_data:[]
                },
                user:{
                    groups:["user__name"],
                    chart_data:[],
                    table_data:[]
                },
                size:{
                    groups:["num_processors"],
                    chart_data:[],
                    table_data:[]
                },
                project:{
                    groups:["projects__name"],
                    chart_data:[],
                    table_data:[]
                },
            },
        },
    };


    var empty_chart=[
        {
            key:"Loading...",
            values:[
            {x:0, y:0}, {x:1, y:0}
            ]
        }
    ];
    function set_active_chart(selector, state){

        chart_data[selector].active = state;
        // Change the classes in the tabs...
        var wanted_selector=selector+"_"+state;
        for (var value in chart_data[selector].data){
            var v = selector+"_"+value;
            document.getElementById(v).className ="";
            if (v.valueOf() === wanted_selector.valueOf()){
                document.getElementById(v).className ="active";
            }
        }

        // Set the attributes for the active graph
        var chart_selector="#" + selector + " svg";
        d3.select(chart_selector)
            .datum(empty_chart)
            .transition().duration(500)
            .call(chart_data[selector].chart);
        d3.select(chart_selector)
            .datum(chart_data[selector].data[state].chart_data)
            .transition().duration(500)
            .call(chart_data[selector].chart);

        $(selector+"_table").html(chart_data[selector].data[state].table_data);
    }


	function clearWidgets(){
	    for (var c_name in chart_data){
	        var selector="#"+c_name+" svg";
	        d3.select(selector)
                .datum(empty_chart)
                .transition().duration(500)
                .call(chart_data[c_name].chart);
            d3.select(selector)
                .datum([])
                .transition().duration(500)
                .call(chart_data[c_name].chart);
            $("#"+c_name+"_table").html('Updating.....');
	    }

	}

    function load_chart(chart_name, view_name){
        var chart_selector="#" + chart_name + " svg";
        var chart_selector="#" + chart_name + "_table";
        var filterData={
			filters:filters,
			excludes:excludes,
			start_time_js:selectedMin,
			end_time_js:selectedMax
		};


		filterData.groups=view.groups;
		filterData.view=chart.chart_view;

		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
            $.getJSON(data.url, function(data) {
                var chart=chart_data[chart_name];
		        var view=chart.data[view_name];
                view.chart_data=data['data'];
                if (chart.active==view_name){
                    d3.select(chart_selector)
                    .datum(view.chart_data)
                    .transition().duration(500)
                    .call(chart.chart);
                }
            });
        });
        if (chart.hasOwnProperty( "table_view" )){
            filterData.view=chart.table_view;
            $.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
                $.get(data.url, function(data) {
                    view.table_data=data;
                    // Check if selected, then display....
                    if (chart.active==view_name){
                        $(table_selector).html(view.table_data);
                    }
                });
            });
        }


    }
	function loadWidgets(){
		// Loads data into widgets
		var filterData={
			view:'lf_utilization_view',
			filters:filters,
			excludes:excludes,
			groups:[],
			start_time_js:selectedMin,
			end_time_js:selectedMax
		};

		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$("#permalinkURL").attr("href", data.url);
		});
		
		filterData.view='lf_util_total_attempts';
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$("#counterText").text(data.count);
		});

        for (var chart_name in chart_data){
            for (var view_name in chart_data[chart_name].data){
                load_chart(chart_name, view_name);
            }
        }
    }



	initializeReport();
</script>

<h1>Utilization</h1>
<p>The Utilization Chart shows the utilization of the cluster grouped by the selected field.  Utilization shows the number
of processors that were in use at any given time, stacked on top of this are the corresponding number of processors that
were pending at that time.  Pending tasks are those that have been submitted to the cluster but are not executing.</p>

<ul id="chart_utilization_nav" class="nav nav-tabs">
    <li id="chart_utilization_overall" class="active"><a href="#" onClick='set_active_chart("chart_utilization", "overall"); return false;'>Overall</a></li>
    <li id="chart_utilization_cluster"><a href="#" onClick='set_active_chart("chart_utilization", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_utilization_queue"><a href="#" onClick='set_active_chart("chart_utilization", "queue"); return false;'>By Queue</a></li>
    <li id="chart_utilization_project"><a href="#" onClick='set_active_chart("chart_utilization", "project"); return false;'>By Project</a></li>
    <li id="chart_utilization_user"><a href="#" onClick='set_active_chart("chart_utilization", "user"); return false;'>By User</a></li>
    <li id="chart_utilization_size"><a href="#" onClick='set_active_chart("chart_utilization", "size"); return false;'>By Size</a></li>
</ul>
<div id="chart_utilization">
    <svg height="400px"></svg>
</div>
<div id="chart_utilization_table"></div>

<h1>Consumption</h1>
<p>The resource consumption chart shows the total amount of time (in seconds) and the number of tasks that were active
    during this time.  Use this chart to see what the net consumption of the cluster is for a specific group of metrics.
    For example to see which job sizes consume the most CPU time on the cluster.</p>
<ul id="chart_consumption_nav" class="nav nav-tabs">
    <li id="chart_consumption_overall" class="active"><a href="#" onClick='set_active_chart("chart_consumption", "overall"); return false;'>Overall</a></li>
    <li id="chart_consumption_size"><a href="#" onClick='set_active_chart("chart_consumption", "size"); return false;'>By Job Size</a></li>
    <li id="chart_consumption_exit"><a href="#" onClick='set_active_chart("chart_consumption", "exit"); return false;'>By Exit Status</a></li>
    <li id="chart_consumption_cluster"><a href="#" onClick='set_active_chart("chart_consumption", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_consumption_project"><a href="#" onClick='set_active_chart("chart_consumption", "project"); return false;'>By Project</a></li>
    <li id="chart_consumption_queue"><a href="#" onClick='set_active_chart("chart_consumption", "queue"); return false;'>By Queue</a></li>
    <li id="chart_consumption_user"><a href="#" onClick='set_active_chart("chart_consumption", "user"); return false;'>By User</a></li>
</ul>

<div id='chart_consumption'><svg style='height:500px'></svg></div>
<div id="chart_consumption_table"></div>

<h1>Resource Usage</h1>
<p>Most schedulers gather resource usage information using the getrusage() system call. Not all schedulers support this
    operation, data will not be available for those jobs.  Use this chart to understand the characteristics of the jobs,
    how much RAM they use, if they are swapping, and if there are contention issues on the cluster for resources.
</p>
<ul id="chart_resources_nav" class="nav nav-tabs">
    <li id="chart_resources_overall" class="active"><a href="#" onClick='set_active_chart("chart_resources", "overall"); return false;'>Overall</a></li>
    <li id="chart_resources_size"><a href="#" onClick='set_active_chart("chart_resources", "size"); return false;'>By Job Size</a></li>
    <li id="chart_resources_cluster"><a href="#" onClick='set_active_chart("chart_resources", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_resources_project"><a href="#" onClick='set_active_chart("chart_resources", "project"); return false;'>By Project</a></li>
    <li id="chart_resources_queue"><a href="#" onClick='set_active_chart("chart_resources", "queue"); return false;'>By Queue</a></li>
    <li id="chart_resources_user"><a href="#" onClick='set_active_chart("chart_resources", "user"); return false;'>By User</a></li>
</ul>

<div id='chart_resources'><svg style='height:500px'></svg></div>
<div id="chart_resources_table"></div>
<h1>Job Submission</h1>
<p>Shows data on when jobs were submitted to the cluster</p>

<ul id="chart_submission_nav" class="nav nav-tabs">
    <li id="chart_submission_overall" class="active"><a href="#" onClick='set_active_chart("chart_submission", "overall"); return false;'>Overall</a></li>
    <li id="chart_submission_size"><a href="#" onClick='set_active_chart("chart_submission", "size"); return false;'>By Job Size</a></li>
    <li id="chart_submission_cluster"><a href="#" onClick='set_active_chart("chart_submission", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_submission_project"><a href="#" onClick='set_active_chart("chart_submission", "project"); return false;'>By Project</a></li>
    <li id="chart_submission_queue"><a href="#" onClick='set_active_chart("chart_submission", "queue"); return false;'>By Queue</a></li>

</ul>

<div id='chart_submission'><svg style='height:500px'></svg></div>
<div id="chart_submission_table"></div>

{% endblock %}
