{% extends "lavaFlow/base.html" %}
{% block actions %} 
	<li>
		<a id="permalinkURL" href='#'><span class="glyphicon glyphicon-link"></span></a>
	</li>
	<li>
	<a href="#"><span id="filterIcon" class="glyphicon glyphicon-filter"></a></span>
	</li>

{% endblock %}
{% block title %}Utilization View{% endblock %}
{% block content %}
<div id="rangeSelector">
	<div id="slider"></div>
	<p id="rangeText">Loading report range....</p>
</div>
<script>
	var selectedMin={{ start_time }};
	var selectedMax={{ end_time }};
	var buildFilterUrl='{{ build_filter_url|safe }}';
	var filters={{ filters|safe }};
	var excludes={{ excludes|safe }};
	var count=0;

	$('#filterIcon').popover({
		"animation":true,
		"placement":"bottom",
		"html":true,
		"title":"Report Information",
		"content":function (){
			return buildPopoverText();
		}
	});
	function buildPopoverText(){
		var h;
		h="<dl><dt># Entries</dt><dd>"+count+"</dd>";
		for (var key in filters) {
	  		if (filters.hasOwnProperty(key)) {
				h += "<dt>Filter on " + key + "</dt><dl>";
				if (endsWith(key,"__in")){
					filters[key].forEach(function(entry){
						h+="<a href='#' onClick=\"removeFilter('"+key+"','"+entry+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+entry+" ";
					});
				}else{
					h+="<a href='#' onClick=\"removeFilter('"+key+"','"+filters[key]+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+filters[key]+" ";
				}
				h +="</dd>";
			}
		}
		for (var key in excludes) {
	  		if (excludes.hasOwnProperty(key)) {
				h += "<dt>Exclude " + key + "</dt><dl>";
				if (endsWith(key,"__in")){
					excludes[key].forEach(function(entry){
						h+="<a href='#' onClick=\"removeExclude('"+key+"','"+entry+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+entry+" ";
					});
				}else{
				h+="<a href='#' onClick=\"removeExclude('"+key+"','"+excludes[key]+"');$('#filterIcon').popover('toggle');$('#filterIcon').popover('toggle');return false;\"><span class=\"glyphicon glyphicon-remove\"></span></a>"+excludes[key]+" ";
				}
				h +="</dd>";
			}
		}
		h+="</dl>";
		return h;
	}	

	// Add the slider
	$( "#slider" ).slider({
		range: true,
		disabled: true,
		slide: function( event, ui ){
			var startDate=new Date(ui.values[0]);
			var endDate=new Date(ui.values[1]);
			$("#rangeText").text('Report start: ' + startDate + ', report end: ' + endDate );
		},
		change: function(event, ui){
			selectedMin=ui.values[0];
			selectedMax=ui.values[1];
			if (! $("#slider").slider("option", "disabled")){
				updateReport();
			}
		},
	});
	










	var jobExitChartBar;
	nv.addGraph(function() {
		jobExitChartBar = nv.models.multiBarChart();
		d3.select('#jobExitChartBar svg')
			.datum([])
			.transition().duration(500)
			.call(jobExitChartBar);
		nv.utils.windowResize(jobExitChartBar.update);
		return jobExitChartBar;
	});

	var jobSizeChartBar;
	nv.addGraph(function() {
		jobSizeChartBar = nv.models.multiBarChart();
		d3.select('#jobSizeChartBar svg')
			.datum([])
			.transition().duration(500)
			.call(jobSizeChartBar);
		nv.utils.windowResize(jobSizeChartBar.update);
		return jobSizeChartBar;
	});




	// Updates the RangeSlider widget, if there is data - loads data into charts.
	function updateRangeSlider(){
	$( "#slider" ).slider( "option", "disabled", true );
		var filterData={
			view:'lf_get_report_range',
			filters:filters,
			excludes:excludes,
			groups:[],
			start_time_js:selectedMin,
			end_time_js:selectedMax
		};
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$.getJSON(data.url, function(data) {
				if (data.count>0){
					count=data.count;
					// If using default values, populate them 
					if ( selectedMin < data.start_time ){
						selectedMin=data.suggested_start_time;
					}
					if ( selectedMax > data.end_time ){
						selectedMax=data.suggested_end_time;
					}
					if (selectedMax-selectedMin < 1){
						selectedMax=data.suggested_end_time;
						selectedMin=data.suggested_start_time;
					}

					// Set the counter to the amount of data
					$("#counterText").text(data.count);

					// Set the report range
					var startDate=new Date(selectedMin);
					var endDate=new Date(selectedMax);
					$("#rangeText").text('Report start: ' + startDate + ', report end: ' + endDate );

					// Set the range
					$( "#slider" ).slider( "option", "max", data.end_time );
					$( "#slider" ).slider( "option", "min", data.start_time );

					// Set the selection
					$( "#slider" ).slider( "option", "values", [ selectedMin, selectedMax ]);
					
					// Enable the slider
					$( "#slider" ).slider( "option", "disabled", false );

					loadWidgets();
				}
				else{
					// Disable the slider
					$( "#slider" ).slider( "option", "disabled", true );
					$("#rangeText").text('No data was found for this filter.' );
				}
			});
		});
	}



	function initializeReport(){
		updateRangeSlider();
	}
	function updateReport(){
		// Disabale the slider
		$( "#slider" ).slider( "option", "disabled", true );

		clearWidgets();
		updateRangeSlider();
	}


	function endsWith(str, suffix) {
    	return str.indexOf(suffix, str.length - suffix.length) !== -1;
	}

	function addFilter(filterName, value){
		if ( endsWith(filterName, "__in" )){
			if ( !filters.hasOwnProperty(filterName) ){
				filters[filterName]=[];
			}
			filters[filterName].push(value)
		}else{
			filters[filterName]=value
		}
		updateReport();
	}
	function removeFilter(filterName,value){
		if (filters.hasOwnProperty(filterName)){
			if (endsWith(filterName, "__in")){
				var loc=filters[filterName].indexOf(value);
				if (loc >-1){
					filters[filterName].splice(loc);
					if ( filters[filterName].length <1 ){
						delete filters[filterName];
					}
					updateReport();
				}
			}
			else{
				delete filters[filterName];
				updateReport();
			}
		}
	}
	function removeExclude(excludeName,value){
		if (excludes.hasOwnProperty(excludeName)){
			if (endsWith(excludeName, "__in")){
				var loc=excludes[excludeName].indexOf(value);
				if (loc >-1){
					excludes[excludeName].splice(loc);
					if ( excludes[excludeName].length <1 ){
						delete excludes[excludeName];
					}
					updateReport();
				}
			}
			else{
				delete excludes[excludeName];
				updateReport();
			}
		}
	}

	function addExclude(excludeName, value){
		if ( endsWith(excludeName, "__in" )){
			if ( !excludes.hasOwnProperty(excludeName) ){
				excludes[excludeName]=[];
			}
			excludes[excludeName].push(value)
		}else{
			excludes[excludeName]=value
		}
		updateReport();
	}

    // Add the utilization charts
	var utilChart;
	nv.addGraph(function() {
		utilChart = nv.models.stackedAreaChart();
		utilChart.clipEdge(true);
		utilChart.xAxis.tickFormat(function(d) { return d3.time.format('%x %X')(new Date(d)) });
		utilChart.xAxis.rotateLabels(-45);
		utilChart.margin({bottom: 120, left:100});
		utilChart.xAxis.axisLabel('Date');
		utilChart.showControls(false);
		d3.select('#chart_utilization svg')
		.datum([])
		.transition().duration(500)
		.call(utilChart);
		nv.utils.windowResize(utilChart.update);
		return utilChart;
	});




    var current_report="overview";
    var report_data={
        overview:{
            chart=[],
            table=""
        },
        cluster:{
                chart:[],
                table:""
            },
        queue:{
                chart:[],
                table:""
            },
        user:{
                chart:[],
                table:""
            },
        size:{
                chart:[],
                table:""
            },
        project:{
                chart:[],
                table:""
            }
       };

    function set_active_chart(selector, state){
        current_report = state;
        // Change the classes in the tabs...
        var as=["overview", "cluster", "queue", "user", "size","project"];
        var ws=selector+"_"+state;
        $.each( as, function( index, value ){
            var v = selector+"_"+value;
            document.getElementById(v).className ="";
        if (v.valueOf() === ws.valueOf()){
                document.getElementById(v).className ="active";
        }
        });

        // Set the attributes for the active graph
        d3.select("#chart_utilization svg")
            .datum(data)
            .transition().duration(500)
            .call(utilChart);
    }

	function clearWidgets(){
		// Clears data from all widgets...
		charts=[
			{
				id:"#chart_utilization svg",
				container:utilChart
			},
			{
				id:"#jobSizeChartBar svg",
				container:jobSizeChartBar
			},
			{
				id:"#jobExitChartBar svg",
				container:jobExitChartBar
			}
		];
		charts.forEach(function(entry){
			d3.select(entry.id)
			.datum([{x:0,y:0},{x:1,y:0}])
			.transition().duration(500)
			.call(entry.container);
			d3.select(entry.id)
			.datum([])
			.transition().duration(500)
			.call(entry.container);
		});

		areas=[
			'#table_utilization',
			];
		areas.forEach(function(entry){
			$(entry).html('Updating.....');
		});
	}

	function loadWidgets(){
		// Loads data into widgets
		var filterData={
			view:'lf_utilization_view',
			filters:filters,
			excludes:excludes,
			groups:[],
			start_time_js:selectedMin,
			end_time_js:selectedMax
		};


		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$("#permalinkURL").attr("href", data.url);
		});
		
		filterData.view='lf_util_total_attempts';
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			$("#counterText").text(data.count);
		});


        // Load data for each of the widgets
		filterData.view='lf_util_chart_view';
		filterData.groups=[];
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
                report_data['overview']['chart']=data['data'];
                // Check if selected, then display....
                if (current_report == "overview"){
                    d3.select("#chart_utilization svg")
                    .datum(report_data['overview']['chart'])
                    .transition().duration(500)
                    .call(utilChart);
                }
		    });
        });

		filterData.view='lf_utilization_table'
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
		        report_data['overview']['table']=data['data'];
    		    // Check if selected, then display....
    		    if (current_report == "overview"){
    		        $("#table_utilization").html(report_data['overview']);
    		    }
	    	});
        });


		filterData.view='lf_util_chart_view';
		filterData.groups=['cluster__name'];
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			 $.getJSON(data.url, function(data) {
				report_data['cluster']['chart']=data['data'];
			    // Check if selected, then display....
			    if (current_report == "cluster"){
                    d3.select("#chart_utilization svg")
                    .datum(report_data['cluster']['chart'])
                    .transition().duration(500)
                    .call(utilChart);
	    		}
			});
		});

		filterData.view='lf_utilization_table'
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
		        report_data['cluster']['table']=data['data'];
		        // Check if selected, then display....
		        if (current_report == "cluster"){
    		        $("#table_utilization").html(report_data['cluster']);
    		    }
		    });
		});


        filterData.view='lf_util_chart_view';
		filterData.groups=['queue__name'];
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
                report_data['queue']['chart']=data['data'];
                // Check if selected, then display....
                if (current_report == "queue"){
                    d3.select("#chart_utilization svg")
                    .datum(report_data['queue']['chart'])
                    .transition().duration(500)
                    .call(utilChart);
                }
            });
        });

        filterData.view='lf_utilization_table'
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
                report_data['queue']['table']=data['data'];
                // Check if selected, then display....
                if (current_report == "queue"){
    		        $("#table_utilization").html(report_data['queue']);
    		    }
		    });
        });


        filterData.view='lf_util_chart_view';
		filterData.groups=['user__name'];
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
           $.getJSON(data.url, function(data) {
                report_data['user']['chart']=data['data'];
			    // Check if selected, then display....
			    if (current_report == "user"){
                    d3.select("#chart_utilization svg")
                    .datum(report_data['user']['chart'])
                    .transition().duration(500)
                    .call(utilChart);
                }
            });
		});

        filterData.view='lf_utilization_table'
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
		        report_data['user']['table']=data['data'];
    		    // Check if selected, then display....
    		    if (current_report == "user"){
    		        $("#table_utilization").html(report_data['user']);
    		    }
            });
		});


        filterData.view='lf_util_chart_view';
		filterData.groups=['num_processors'];
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
                 report_data['size']['chart']=data['data'];
                // Check if selected, then display....
                if (current_report == "size"){
                    d3.select("#chart_utilization svg")
                    .datum(report_data['size']['chart'])
                    .transition().duration(500)
                    .call(utilChart);
                }
			});
		});

		filterData.view='lf_utilization_table'
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
                report_data['overview']['size']=data['data'];
                // Check if selected, then display....
                if (current_report == "size"){
    		        $("#table_utilization").html(report_data['size']);
    		    }
		    });
		});


        filterData.view='lf_util_chart_view';
		filterData.groups=['projects__name'];
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
                report_data['project']['chart']=data['data'];
                // Check if selected, then display....
                if (current_report == "project"){
                    d3.select("#chart_utilization svg")
                    .datum(report_data['project']['chart'])
                    .transition().duration(500)
                    .call(utilChart);
                }
            });
		});

		filterData.view='lf_utilization_table'
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
		    $.getJSON(data.url, function(data) {
                report_data['project']['table']=data['data'];
                // Check if selected, then display....
                if (current_report == "project"){
    		        $("#table_utilization").html(report_data['project']);
    		    }
		    });
		});


		filterData.view='lf_util_bar_exit';
		filterData.groups=['status__name'];
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			 $.getJSON(data.url, function(data) {
				d3.select('#jobExitChartBar svg')
				.datum(data)
				.transition().duration(500)
				.call(jobExitChartBar);
			});

		});


		filterData.view='lf_util_bar_size';
		filterData.groups=['num_processors'];
		$.post(buildFilterUrl,JSON.stringify(filterData),function( data ){
			 $.getJSON(data.url, function(data) {
				d3.select('#jobSizeChartBar svg')
				.datum(data)
				.transition().duration(500)
				.call(jobSizeChartBar);
			});

		});
		


	}








	initializeReport();









</script>



<h1>Utilization</h1>

<ul id="chart_utilization_nav" class="nav nav-tabs">
    <li id="chart_utilization_overall" class="active"><a href="#" onClick='set_active_chart("chart_utilization", "overall"); return false;'>Overall</a></li>
    <li id="chart_utilization_cluster"><a href="#" onClick='set_active_chart("chart_utilization", "cluster"); return false;'>By Cluster</a></li>
    <li id="chart_utilization_queue"><a href="#" onClick='set_active_chart("chart_utilization", "queue"); return false;'>By Queue</a></li>
    <li id="chart_utilization_project"><a href="#" onClick='set_active_chart("chart_utilization", "project"); return false;'>By Project</a></li>
    <li id="chart_utilization_user"><a href="#" onClick='set_active_chart("chart_utilization", "user"); return false;'>By User</a></li>
    <li id="chart_utilization_job_size"><a href="#" onClick='set_active_chart("chart_utilization", "job_size"); return false;'>By Size</a></li>
</ul>
<div id="chart_utilization">
    <svg height="400px"></svg>
</div>
<div id="table_utilization"></div>







<h3>Job Size</h3>
<div id='jobSizeChartBar'><svg style='height:500px'></svg></div>
<h3>Exit State</h3>
<div id='jobExitChartBar'><svg style='height:500px'></svg></div>

{% endblock %}
